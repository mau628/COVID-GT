<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-GT</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Roboto', sans-serif;
        }
    </style>
</head>

<body>
    <h3>Casos diarios para COVID-19 en Guatemala</h3>
    <label for="inicio">Desde</label>
    <input type="date" name="inicio" id="inicio" onchange="update()">
    <br>
    <label for="fin">Hasta</label>
    <input type="date" name="fin" id="fin" onchange="update()">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"
        integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg=="
        crossorigin="anonymous"></script>
    <div style="height: 768px;"><canvas id="canvas"></canvas></div>

    <script>
        var chart;
        var dataset;
        function update() {
            var desdeString = document.getElementById("inicio").value;
            var hastaString = document.getElementById("fin").value;

            if (desdeString.length === 0 || hastaString.length === 0)
                return;

            var dateDesde = new Date(desdeString);
            dateDesde.setDate(dateDesde.getDate());
            var desde = dateDesde.toISOString();

            var dateHasta = new Date(hastaString);
            dateHasta.setDate(dateHasta.getDate() + 2);
            var hasta = dateHasta.toISOString();

            var analyticsData = [];
            var prevItem = {};
            dataset.forEach(item => {
                if (!!desde && item.Date < desde)
                    return;
                if (!!hasta && item.Date > hasta)
                    return;

                var cases = {
                    confirmed: item.Confirmed,
                    deaths: item.Deaths,
                    recovered: item.Recovered,
                    active: item.Active,
                    date: item.Date
                };
                if (!!prevItem) {
                    cases.confirmed = item.Confirmed - prevItem.Confirmed;
                    cases.deaths = item.Deaths - prevItem.Deaths;
                    cases.recovered = item.Recovered - prevItem.Recovered;
                }
                prevItem = item
                analyticsData.push(cases);
            });

            var labels = analyticsData.map(function (e) {
                return new Date(e.date).toLocaleDateString("es-GT");
            });
            var dataConfirmed = analyticsData.map(function (e) {
                return e.confirmed;
            });
            var dataDeaths = analyticsData.map(function (e) {
                return e.deaths;
            });
            var dataRecovered = analyticsData.map(function (e) {
                return e.recovered;
            });

            // 0: Confirfmados
            // 1: Fallecidos
            // 2: Recuperados
            chart.data.labels = labels;
            chart.data.datasets[0].data = dataConfirmed;
            chart.data.datasets[1].data = dataDeaths;
            chart.data.datasets[2].data = dataRecovered;
            chart.update();
        }

        function httpGetAsync(theUrl, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                    callback(xmlHttp.responseText);
            }
            xmlHttp.open("GET", theUrl, true); // true for asynchronous 
            xmlHttp.send(null);
        }

        function callback(data) {
            dataset = JSON.parse(data);
            var analyticsData = [];
            var prevItem = {};
            dataset.forEach(item => {
                var cases = {
                    confirmed: item.Confirmed,
                    deaths: item.Deaths,
                    recovered: item.Recovered,
                    active: item.Active,
                    date: item.Date
                };
                if (!!prevItem) {
                    cases.confirmed = item.Confirmed - prevItem.Confirmed;
                    cases.deaths = item.Deaths - prevItem.Deaths;
                    cases.recovered = item.Recovered - prevItem.Recovered;
                }
                prevItem = item
                analyticsData.push(cases);
            });

            var labels = analyticsData.map(function (e) {
                return new Date(e.date).toLocaleDateString("es-GT");
            });
            var dataConfirmed = analyticsData.map(function (e) {
                return e.confirmed;
            });
            var dataDeaths = analyticsData.map(function (e) {
                return e.deaths;
            });
            var dataRecovered = analyticsData.map(function (e) {
                return e.recovered;
            });


            var ctx = canvas.getContext('2d');
            var config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Confirmados',
                        data: dataConfirmed,
                        backgroundColor: 'rgba(214, 193, 36, 0.3)',
                        borderColor: 'rgba(214, 193, 36, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Fallecidos',
                        data: dataDeaths,
                        backgroundColor: 'rgba(221, 54, 54, 0.3)',
                        borderColor: 'rgba(221, 54, 54, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Recuperados',
                        data: dataRecovered,
                        backgroundColor: 'rgba(59, 183, 31, 0.3)',
                        borderColor: 'rgba(59, 183, 31, 1)',
                        borderWidth: 2
                    },
                    ]
                },
                options: {
                    scales: {
                        yAxes: [{
                            type: 'logarithmic',
                            ticks: {
                                min: 0,
                                max: 20000,
                                callback: function (value, index, values) {
                                    if (value === 20000) return "20K";
                                    if (value === 15000) return "15K";
                                    if (value === 10000) return "10K";
                                    if (value === 5000) return "5K";
                                    if (value === 1000) return "1K";
                                    if (value === 100) return "100";
                                    if (value === 10) return "10";
                                    if (value === 0) return "0";
                                    return null;
                                }
                            }
                        }]
                    },
                    responsive: true,
                }
            };

            chart = new Chart(ctx, config);
        }

        httpGetAsync("https://api.covid19api.com/total/country/guatemala", callback);
    </script>

</body>

</html>